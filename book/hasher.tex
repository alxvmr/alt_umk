\hypertarget{5}{\chapter{Инструмент Hasher}}
\Emph{Hasher} --- инструмент для сборки пакетов с использованием изолированной среды (\Sys{chroot}).
Представляет собой сложный усовершенствованный инструмент, направленный на устранение недостатков,
связанных с процессом сборки пакетов в локальной среде средствами \Sys{rpm-build}.
\begin{itemize}
	    \item Благодаря входящим в комплект утилитам упрощается процесс поддержания сборочных зависимостей и сохранение
целостности пакета.
	    \item  Изолированная среда обновляется для каждой сборки, инициированной средствами \Sys{Hasher},
что гарантирует независимый от конфигурации операционной системы процесс сборки пакета.
	    \item  Изменяя конфигурацию источников для \Sys{Hasher}, указывая различные
репозитории, возможно собирать пакеты для пакетных баз отличных от локальной
операционной системы.
\end{itemize}

Для начала работы необходимо установить пакет \Sys{hasher} и настроить работу с утилитой:
\begin{verbatim}
# apt-get install hasher
\end{verbatim}

Возможности \Sys{Hasher} задокументированы%
\footnote{\href{http://uneex.ru/static/AltlinuxOrg_Hasher/}{http://uneex.ru/static/AltlinuxOrg\_Hasher/}}.
\begin{verbatim}
$ man hsh
\end{verbatim}

\begin{verbatim}
$ man hasher-priv
\end{verbatim}

\hypertarget{5.1}{\section{Настройка Hasher}}
Для начала работы необходимо настроить утилиту:
\begin{itemize}
\item Запустить демон \Sys{hasher-priv}(необходимо начиная с версии hasher 2.0):
\begin{verbatim}
# systemctl enable --now hasher-privd.service
\end{verbatim}

\item Подготовить учётную запись для работы с \Sys{hasher} можно средствами встроенной утилиты.
Пользователь должен отличаться от корневого супер пользователя(\Sys{root}) и должен быть
лишен повышенных привилегий для обеспечения безопасности системы от процесса сборки.
Утилита создаст дополнительных пользователей добавит в необходимы группы и настроит
\Sys{hasher} для работы от указанного пользователя:
\begin{verbatim}
# hasher-useradd <имя учетной записи>
\end{verbatim}
\marginalia{ex_sign_col}{Если утилитой \Sys{hasher-useradd} настраивается активный пользователь в системе, то
поскольку утилита производит манипуляции с добавлением пользователя группы, пользователю
необходимо создать новую или перезапустить рабочую сессию, чтобы изменения вступили в силу.}

\item Создать каталоги расположения сборочной среды и каталоги настроек(следующие указанные
пути используются утилитой  по умолчанию):
\begin{verbatim}
$ mkdir ~/hasher
$ mkdir ~/.hasher
\end{verbatim}

Необходимо добавить имя в указанном формате в конфигурационный файл:
\begin{verbatim}
$ echo 'packager="Ваше Имя <login@altlinux.org>"' >> ~/.hasher/config
\end{verbatim}
Этот параметр важен для встроенных проверок \Sys{hasher}.

При создании каталога \Sys{hasher} следует учитывать два правила:
\begin{enumerate}
	\item права доступа соответствуют \Sys{drwxr-xr-x}, то есть каталог доступен на запись;
	\item на файловой системе, смонтированной с \Sys{noexec} или \Sys{nodev}, каталог располагать нельзя%
\footnote{\href{https://serverfault.com/questions/547237/explanation-of-nodev-and-nosuid-in-fstab}{https://serverfault.com/questions/547237/explanation-of-nodev-and-nosuid-in-fstab}};
	\begin{itemize}
		\item \Sys{noexec} устанавливается, если в системе есть файлы с правами \Sys{rwsr-xr-x}
			(запустить исполняемые файлы с правами владельца или группы) и владельцем \Sys{root}.
			Запустить файл \Sys{rwxr-xr-x} на такой файловой системе невозможно. а следовательно,
			и создать корректное сборочное окружение. \Sys{Hasher} не зависит от пользовательского окружения.
		\item \Sys{nodev} говорит о том, что на файловой системе не будут созданы файлы устройств.
			Это не соответствует функциональности \Sys{hasher} (см.~раздел 5.7
			\hyperlink{mount_fs_hasher}{<<Монтирование файловых систем внутри \Sys{Hasher}>>}).
	\end{itemize}
\end{enumerate}
\end{itemize}
Если всё сделано верно, мы сможем создать минимальное сборочное окружение, исполнив команду:
\begin{verbatim}
$ hsh --initroot-only
\end{verbatim}
По умолчанию сборочное окружение создается в каталоге \Sys{$\sim$/hasher}. Для инициализации окружения
этот каталог должн существовать. Можно переобозначить путь для сборочного окружения по умолчанию.
Для этого нужно создать каталог, в котором планируем расположить новое сборочное окружение и выполнить
команду с переобозначенным путем:
\begin{verbatim}
$ mkdir ~/some-new-hasher
$ hsh --initroot-only ~/some-new-hasher
\end{verbatim}
Окружение сбрасывается для каждого нового запущенного процесса сборки, и создается заново, если
не существовало. При необходимости содержимое каталога может быть очищено с правами
супер пользователя.\\
\\
Часто используемые параметры конфигурации $\sim$/.hasher/config:
\begin{itemize}
	\item \Sys{packager='' ` rpm --eval \%packager ` ''} --- альтернативный варинт указать параметр \Sys{packager} для \Sys{rpm}.
	(Будет работать если заполнен макрос  \Sys{\%packager} в \Sys{$\sim$/.rpmmacros});
	\item \Sys{allowed\_mountpoints=/dev/pts,/proc,/dev/shm} --- параметр подключать в корень изолированного сборочного
	окружения список локальных файловых систем;
	\item \Sys{no\_sisyphus\_check="packager,buildhost,gpg"} ---
	\item \Sys{lazy\_cleanup=1} --- команда очищать среду сборки перед каждой новой сборкой;
	\item \Sys{apt\_config="\$HOME/.hasher/apt.conf"} --- параметр позволяет переобозначить конфигурацию источников
	репозиториев для сборочного окружения.
\end{itemize}

\section{Описание системы Hasher}
Переместиться в корень сборочного окружения можно выполнив команду:
\begin{verbatim}
$ hsh-shell
\end{verbatim}
Приведенная команда перемещает командную оболочку в изолированную среду \Sys{hasher}.
Команда позволяет перемещаться по структуре изолированного окружения и продолжить работу
внутри.\\
\\
Опишем структуру каталогов \Sys{hasher}.

\begin{itemize}
	\item \Sys{$\sim$/hasher}
	\begin{itemize}
		\item \Sys{chroot} --- сборочное окружение. В этом каталоге находится
			корневое дерево содержащее минимальный набор пакетов, необходимых
			для сборки.
		\item \Sys{aptbox} --- набор утилит для установки, обновления и удаления
			пакетов \Sys{chroot}. Например, тут лежит модифицированный \Sys{apt-get},
			с помощью которого происходит установка пакетов в \Sys{chroot}.
		\item \Sys{cache} --- в этом каталоге хранятся временные файлы, необходимые для
			создания \Sys{chroot}.
	\end{itemize}
		\item \Sys{repo}, который содержит подкаталоги:
	\begin{itemize}
		\item \Sys{SRPMS.hasher} --- пакеты с исходными данными (sources).
		\item \Sys{<архитектура>/RPMS.hasher/} --- каталог с пакетами, собранными
			под конкретную архитектуру.
			Содержимое каталога дополняет источники пакетов для сборочного окружения.
			Помещенные в него пакеты можно установить в изолированном окружении \Sys{hasher}.
			Такой механизм позволяет добавлять в сборочные зависимости и использовать пакеты, в
			изолированной среде которых еще не существует в подключенных репозиториях.
	\end{itemize}
	\item \Sys{$\sim$/.hasher} --- каталог конфигурационных файлов. Каталог может отсутсвовать,
	в этом случае \Sys{hasher} использует конфигурацию по умолчанию.
	\begin{itemize}
		\item \Sys{apt.config} --- конфигурация для \Sys{apt-get} из \Sys{$\sim$/hasher/aptbox/}.
		\item \Sys{config} --- конфигурация самого \Sys{hasher}.
	\end{itemize}
	\item \Sys{/etc/hasher-priv/} каталог с конфигурацией для вспомогательной утилиты \Sys{hasher-priv}.
	\begin{itemize}
		\item \Sys{./user.d} --- каталог содержит файлы настроенных пользователей для работы с \Sys{hasher}.
		\item \Sys{fstab} --- информация о точках монтирования вспомогательной программы \Sys{hasher-priv}
		\Sys{system} --- конфигурация вспомогательной программы \Sys{hasher-priv}.
	\end{itemize}
\end{itemize}

В структуре каталогов \Sys{hasher} стоит обратить внимание на служебные подкаталоги,
позволяющие взаимодействовать с локальной системой:
\begin{itemize}
	\item \Sys{$\sim$/hasher/chroot/.in} --- предполагает добавление файлов из локальной системы.
	\item \Sys{$\sim$/hasher/chroot/.out} --- предполагает получение файлов из \Sys{chroot} системы.
\end{itemize}

Непосредственно структура каталогов \Sys{rpmbuild} сборки находится:
\begin{verbatim}
~/hasher/chroot/usr/src/RPM
\end{verbatim}

\Sys{Hasher} умеет монтировать внутрь изолированной среды виртуальные файловые системы
из локальной машины%
\footnote{\href{https://www.altlinux.org/Hasher/\%D0\%A0\%D1\%83\%D0\%BA\%D0\%BE\%D0\%B2\%D0\%BE\%D0\%B4\%D1\%81\%D1\%82\%D0\%B2\%D0\%BE\#\%D0\%9C\%D0\%BE\%D0\%BD\%D1\%82\%D0\%B8\%D1\%80\%D0\%BE\%D0\%B2\%D0\%B0\%D0\%BD\%D0\%B8\%D0\%B5_\%D1\%84\%D0\%B0\%D0\%B9\%D0\%BB\%D0\%BE\%D0\%B2\%D1\%8B\%D1\%85_\%D1\%81\%D0\%B8\%D1\%81\%D1\%82\%D0\%B5\%D0\%BC_\%D0\%B2\%D0\%BD\%D1\%83\%D1\%82\%D1\%80\%D0\%B8_hasher}{https://www.altlinux.org/Hasher/Руководство}}.
Этот механизм применяется в тех случаях, когда собираемому приложению для сборки требуется доступ к ресурсам
основной машины, которые \Sys{Hasher} не предоставляет по умолчанию. Например, виртуальная файловая система
\Sys{/proc} или \Sys{/dev/pts}, которых по умолчанию нет в \Sys{hasher}-контейнере. Файловая система \Sys{/proc}
получает информацию о состоянии и конфигурации ядра и системы.

Для монтирования файловой системы следует:
\begin{enumerate}
    \item В файле \Sys{/etc/hasher-priv/fstab} описать файловую систему.
    \item В файле \Sys{/etc/hasher-priv/system} указать файловую систему с помощью опции \Sys{allowed\_mointpoints}.
    \item Указать файловую систему либо при запуске \Sys{Hasher} в опции \Sys{--mountpoints}, либо в
        конфигурационном файле \Sys{$\sim$/.hasher/config} в ключе \Sys{known\_mount\-points}.
    \item Прописать необходимую файловую систему в \Sys{SPEC}-файле в теге \Sys{BuildReq}, либо в списке зависимостей.
\end{enumerate}


\section{Сборка в Hasher}
Сборка выполняется от предварительно настроенного пользователя
(см.~раздел~5.1 \hyperlink{5.1}{<<Базовая настройка \Sys{Hasher}>>}).

Изначально сборка в \Sys{hasher} предполагает наличие подготовленного \Sys{.src.rpm} пакета
(см.~раздел 3.3 \hyperlink{rpm-pack-desc}{\mbox{<<Описание \Sys{RPM}-пакета>>}}),
или специально подготовленного \Sys{tar} архива.

Для запуска сборки необходим подготовленный \Sys{.src.rpm} (см.~раздел~4
\hyperlink{rpmbuild-exampl-src}{<<Пример оборки пакета с исходными данными \Sys{.src.rpm}>>}),
после чего можно запустить сборку, выполнив команду:

\begin{verbatim}
$ hsh ./<имя пакета>.src.rpm
\end{verbatim}

Для сборки можно передать специально подготовленный архив \Sys{.tar}. Приведем упрощенный пример
использования архива для сборки.

Пример структуры каталога для архива:
\begin{verbatim}
./
├── <имя пакета>.spec
├── <имя патча>.patch
└── <имя пакета>-<версия из spec>.tar
                 └── <имя пакета>-<версия из spec>  --- Имя каталога с исходными данными для пакета.
\end{verbatim}

Упрощенный пример команды для создания \Sys{.tar} архива:
\begin{verbatim}
$ tar --create --file=pkg.tar --label=<имя пакета>.spec <имя пакета>-<версия из spec>.tar <имя патча>.patch <имя пакета>.spec
\end{verbatim}

Подготовленный архив можно запустить на сборку, выполнив команду:
\begin{verbatim}
$ hsh ./pkg.tar
\end{verbatim}

Собранный бинарный пакет появляется в директории:\\ \Sys{$\sim$/.hasher/repo/<архитектура>/RPMS.hasher/}.\\

Собрать пакет в изолированной среде можно в ручную из исходных данных, инструмент rpmbuild (пример работы
в главе~4  \hyperlink{rpmbuild}{<<Инструмент rpmbuild>>}). Для этого подготовленный файл \Sys{.spec} и архив
с исходными данными нужно поместить в сборочное окружение, воспользовавшись служебным каталогом
\Sys{$\sim$/hasher/chroot/.in}, и провести сборку \Sys{rpmbuild} внутри подготовленного сборочного окружения.

Из-за своей сложности инструмент не используется отдельно и приведен для ознакомления и
подготовки к работе в дальнейшем. Полноценно функционал инструмента раскрывается в связке
с \Sys{Gear}(инструмент Gear будет описан в следующей главе).

\section{Вопросы для самопроверки}

\begin{enumerate}
    \item Что такое \Sys{hasher} и для чего он предназначен?
    \item Каквыа структура каталогов \Sys{hasher}?
    \item Почему ранее собранные в \Sys{hasher} пакеты не оказывают влияния на новую сборку?
    \item Можно ли указать из какого репозитория будет происходить сборка в \Sys{hasher}?
    \item Какие шаги, помимо установки, необходимо сделать для настройки \Sys{hasher}?
    \item Какие два сценария сборки возможны при использовании \Sys{hasher}?
    \item Что такое зависимость программного пакета?
    \item Какие зависимости называют <<сборочными>>, а какие <<времени исполнения>>?
    \item Как посмотреть справочную информацию по пакету \Sys{hasher} и \Sys{hasher-priv}?
    \item Зачем монтировать внутрь \Sys{hasher} файловые системы?
\end{enumerate}