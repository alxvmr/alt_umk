\chapter{Пакетный менеджер}\label{package-manager}
Операционная система состоит из разнообразных программ, библиотек, скриптов и приложений --- 
число компонент может достигать тысячи единиц. В каждой из которых могут быть включены десятки файлов. 
Для удобства работы пользователя системные компоненты в \Sys{Linux} представлены в виде 
пакетов\footnote{\href{https://docs.altlinux.org/books/altlibrary-linuxintro2.pdf}{Курячий Г., Маслинский К. (2010)}. 
Операционная система Linux. Курс лекций. ДМК Пресс.}. Пакет объединяет в общий архив файлы сходные
по назначению: исполняемые програмы, наборы библиотек, скрипты или конфигурациионые файлы и данные.
Пользователь выбирает программы ориентируяс на общеизвестное имя --- устанавливает, обновляет, проверяет,
удаляет их, не вдаваясь в отдельные детали подбора всех необходимых файлов и компонентов.
Работа с пакетами, позволяет сохронять целостность программы со всеми её компонентами.

\Emph{Пакет} --- это специально подготовленный архив, содержащий программы, конфигурационные файлы, 
данные и управляющую информацию. Метаданные пакета содержат полное имя, номер версии, принадлежность
архитектуре, цифровую подпись, описание пакета, информацию о лицензии и некторую служебную информацию
о сборке. Управляющая информация пакета содержит сценарии установки и удаления пакета,  зависимости
устанавливаемого пакета от других пакетов, краткое описание,  и прочую информацию, которую использует
менеджер пакетов. Пакеты принято хранить в специальном хранилище --- \Emph{репозитории пакетов}.

Для удобства работы команды разработчиков придумали собственные форматы архивов:

\begin{itemize}
	\item \Sys{RPM (.rpm)}. Разработан компанией \Sys{Red Hat}. Применяется в системе \Sys{Альт}, \Sys{Ред ОС}, \Sys{RHEL} и \Sys{CentOS}.
	\item \Sys{DEB (.deb)}. Формат пакетов дистрибутива \Sys{Debian}, а также \Sys{Ubuntu}.
	\item \Sys{TAR.XZ}. Применяется в дистрибутивах \Sys{ArchLinux} и \Sys{Manjaro}.
	\item \Sys{APK(.apk)}. Применяется в операционной системе \Sys{Android}.
\end{itemize}

Каждый пакет определяется именем, архитектурой системы под которую он собран,
номером её версии и номером релизом этой программы в дистрибутиве. Если пакет не зависит
от архитектуры процессора, то в качестве архитектуры указывается <<noarch>>.

Например, \Sys{admc-0.15.0-alt1.x86\_64.rpm}:

\noindent
\hspace{0.2cm}
	\begin{tabular}{ll}
		Имя: & \Sys{admc} \\
		Номер версии: & \Sys{0.15.0}\\
		Номер релиза: & \Sys{alt1}\\
		Архитектура: &  \Sys{x86\_64}\\
	\end{tabular}

\Emph{Зависимость пакета} --- потребность компонентов в составе пакета в ресурсах или компонетах  прочих пакетов.
Может случиться, что успешного запуска программыизодного пакета необходимы библиотеки или другие ресурсы,
которые находятся в другом пакете. В таком случае говорят о зависимости пакета от одного или нескольких пакетов.
Для таких пакетов пакетный менеджер запретит установку в систему без, установки всех необходимых пакетов,
удовлетворяющих зависимости.

\Emph{Пакетный менеджер(система управления пакетами)} --- это система управления: установкой, удалением, настройкой
и обновлением пакетов. Пакетные менеджер, средствам входащих в него состав утилит, упрощают для пользователя
процесс управления пакетами в операционной системе. Пакетный менеджер ведёт учёт пакетов, установленных в системе.
Существует менеджер зависимостей --- специальная программа, подбирающая пакеты, зависимые друг от друга, и
загружающая эти пакеты из
хранилища\footnote{\href{https://static-sl.insales.ru/files/1/3828/14544628/original/B-BHV-6630_part.pdf}
{Кетов Д. (2021). Внутреннее устройство Linux. 2-е изд,. перераб. и доп. БХВ-Петербург.}}. 
Менеджер зависимостей подбирает правильные версии пакетов и определяет порядок их установки. 
При помощи менеджера зависимостей можно узнать, с каким пакетом поставляется тот или иной файл.

Задачи пакетного менеджера:

\begin{itemize}
	\item \Emph{установка программ}. Позволяет устанавливать программы из центрального хранилища или из локальных источников;
	\item \Emph{обновление программ}. Позволяет обновлять установленные программы до последних версий, представленных в хранилище;
	\item \Emph{удаление программ}. Позволяет безопасно удалять программы и все связанные с ними файлы;
	\item \Emph{управление зависимостями}. Автоматически устанавливает и управляет зависимостями программ;
	\item \Emph{проверка целостности пакетов}. Предотвращает конфликты при установке новых программ, обеспечивая целостность. системы.
\end{itemize}

Утилиты пакетного менеджера позволяют:

\begin{itemize}
	\item узнать информацию о пакете;
	\item определить пакет, которому принадлежит установленная программа;
	\item определить список компонент, установленных из указанного пакета.
\end{itemize}

Среди утилит пакетного менеджера можно выделить две категории --- низкоуровневые и высокоуровневые.

\begin{itemize}
	\item \Emph{Низкоуровневые утилиты пакетного менеджера}. Используются для установки
		локальных пакетов, загруженных вручную пользователем, или высокоуровневым пакетным менеджером.
	\item \Emph{Высокоуровневые утилиты}. Применяются для поиска и скачивания пакетов из репозиториев.
		В процессе работы могут задействовать низкоуровневые менеджеры для установки загруженных программ.
\end{itemize}

В операционной системе \Sys{Альт} используется формат пакетов \Sys{.rpm}. 
Пакеты \Sys{rpm} хранятся в удалённом хранилище.
Для работы с такими пакетами применяется низкоуровневый пакетный менеджер \Sys{RPM} 
и консольная утилита \Sys{APT} (Advanced Packaging Tool). 


\section{RPM: основной пакетный менеджер в Альт Платформа}
В дистрибутивах \Sys{Альт} применяется пакетный менеджер \Sys{RPM}. \Sys{RPM Package Manager} --- 
это семейство пакетных менеджеров, применяемых в различных дистрибутивах \Sys{GNU/Linux}. 
Практически каждый крупный проект, использующий \Sys{RPM}, имеет свою версию пакетного менеджера, 
отличающуюся от остальных.

Различия между представителями семейства \Sys{RPM} выражаются в:

\begin{itemize}
	\item наборе макросов, используемых в \Sys{.spec-файлах};
	\item различии сборки \Sys{rpm}-пакетов <<по умолчанию>> --- при отсутствии каких-либо 
		указаний в \Sys{.spec}-файлах, формате строк зависимостей;
	\item отличиях в семантике операций (например, в операциях сравнения версий пакетов);
	\item отличиях в формате файлов.
\end{itemize}

Обратим внимание на то, что в операционных системах Alt ведется самостоятельная
разработка формата rpm и пакетного менеджера APT. Набор утилит APT в Alt отличается
от аналогичной по названию программы в Debian, также как и RPM отличается от
аналогичного пакетного менеджера в RedHat.

\section{APT: инструменты управления пакетами}
\Sys{APT} --- часть системы управления пакетами в дистибутивах Альт. Advanced Packaging Tool
(усовершенствованный инструмент работы с пакетами) набор утилит позволяющий управлять пакетами.
Утилита загружает пакеты из хранилища (репозитория).

Emph{Хранилище(репозиторий)} ---  в общем виде хранилище данных.

В операционной системе \Sys{Альт} пакетный менеджер работает с репозиторием rpm пакетов.

Emph{Репозиторий пакетов} --- это замкнутая совокупность компонентов системы с
поддерживаемой целостностью и метаинформации о них, то есть структурированые
компоненты с формализованными инструкциями по установке и разрешенными зависимостями.

Хранилище состоит из двух частей --- индексы(списки пакетов с служебной информацией), и
хранилище (структурированые файлы пакетов).
 \Sys{APT}, в зависимости от настроек, может использовать удалённый репозиторий
с помощью сетевого протокола (например, \Sys{ftp}), или использовать локальный репозиторий (например,
на оптическом диске).
Список источников пакетов хранится в файле
\Sys{/etc/apt/sources.list} и в каталоге \Sys{/etc/apt/sources.list.d/}. В системе \Sys{Альт} 
применяется графическая оболочка для \Sys{apt} --- программа \Sys{Synaptic}\footnote{apt и synaptic 
развиваются ALT Linux Team, не нужно сравнивать реализации с аналогичными утилитами в \Sys{Debian}}.
Утилита \Sys{apt-get} значительно упрощает процесс установки программ в командном режиме.

\marginalia{ex_sign_col}{Для сокращения команд, встречающихся в тексте,  используется нотация:
\begin{itemize}
	\item[-] команды \textbf{без административных привилегий} начинаются с
	символа <<\$>>;
	\item[-] команды \textbf{с административными привилегиями} начинаются с символа <<\#>>.
\end{itemize}}

Команда \Sys{\$ apt-get} выведет описание и возможности утилиты \Sys{apt-get}:
\begin{verbatim}
	$ apt-get
	apt 0.5.15lorg2 для linux x86_64 собран Jul 26 2023 18:10:41
	Использование: apt-get [параметры] команда
	apt-get [параметры] install|remove пакет1 [пакет2 ...]
	apt-get [параметры] source пакет1 [пакет2 ...]
	
	apt-get предоставляет простой командный интерфейс для получения и
	установки пакетов. Чаще других используются команды update (обновить)
	и install (установить).
	
	Команды:
	update - Получить обновлённые списки пакетов
	upgrade - Произвести обновление
	install - Установить новые пакеты
	remove - Удалить пакеты
	source - Скачать архивы исходников
	build-dep - Установить всё необходимое для сборки исходных пакетов
	dist-upgrade - Обновление системы в целом, см. apt-get(8)
	clean - Удалить скачанные ранее архивные файлы
	autoclean - Удалить давно скачанные архивные файлы
	check - Удостовериться в отсутствии неудовлетворённых зависимостей
	dedup - Remove unallowed duplicated pkgs
	
	Параметры:
	-h  Краткая справка
	-q  Скрыть индикатор процесса
	-qq Не показывать ничего кроме сообщений об ошибках
	-d  Получить пакеты и выйти БЕЗ их установки или распаковки
	-s  Симулировать упорядочение вместо реального исполнения
	-y  Автоматически отвечать 'ДА' на все вопросы
	-f  Пытаться исправить положение если найдены неудовлетворённые зависимости
	-m  Пытаться продолжить если часть архивов недоступна
	-u  Показать список обновляемых пакетов
	-b  Собрать пакет после получения его исходника
	-D  При удалении пакета стремиться удалить компоненты, от которых он зависит
	-V  Подробно показывать номера версий
	-c=? Использовать указанный файл конфигурации
	-o=? Изменить любой из параметров настройки (например: -o dir::cache=/tmp)
\end{verbatim}

	Более полное описание доступно на страницах руководства man:
	\Sys{apt-get, sources.list} и \Sys{apt.conf}:
\begin{itemize}
	\item\begin{verbatim}$ man apt-get\end{verbatim}
	\item\begin{verbatim}$ man sources.list\end{verbatim}
	\item\begin{verbatim}$ man apt.conf\end{verbatim}
\end{itemize}

В ОС \Sys{Альт} утилита \Sys{apt-get} использует основной пакетный менеджер \Sys{RPM Package Manager} --- 
\Sys{RPM} для установки, обновления, удаления пакетов, управления зависимостями. Обе
утилиты \Sys{rpm} и \Sys{apt-get} позволяют установить, обновить или удалить пакет.

Отличия \Sys{rpm} и \Sys{apt-get}:
\begin{itemize}
	\item \Sys{apt-get} учитывает зависимости устанавливаемого пакета;
	\item \Sys{apt-get} умеет работать с репозиторием в целом:
	\begin{itemize}
		\item искать пакеты;
		\item вычислять список обновлений --- находить разницу версий пакетов, 
			установленных локально и хранящихся в репозитории;
	\end{itemize}
	\item \Sys{apt-get} получает информацию из пакетов, используя \Sys{RPM}.
\end{itemize}

\Sys{rpm} подразумевает работу с конкретными пакетами. Пользователь самостоятельно
принимает решение связанные с зависимостями пакетов  при работе с \Sys{RPM}. Утилита \Sys{apt-get}
вычисляет и устанавливает необходимые пакеты из репозитория, чтобы удовлетворить зависимости для
каждого \Sys{RPM} пакета. Утилита \Sys{apt-get} самостоятельно не устанавливает пакеты, а использует для этого \Sys{RPM}.

\marginalia{ex_sign_col}{Установка пакетов в АЛЬТ Платформа осуществляется с помощью утилит \Sys{APT}}
	
\Emph{Репозиторий} --- актуализируемое хранилище электронных данных.
В данном документе речь идёт о репозитории как об инфраструктуре разработки операционных систем, включающих, 
помимо системного ПО, любые программы пользовательского и серверного назначения (<<репозиторий пакетов>>). 
Основная задача репозиториев этого рода --- интеграция разных пакетов программ в единую систему. Объектом 
хранения в таких репозиториях выступают пакеты программ, где каждое наименование ПО (будь то ядро операционной 
системы, служебная библиотека, текстовый редактор, сервер для обслуживания электронных сообщений или медиа 
проигрыватель) представлено в виде отдельного пакета. В основе операционных систем \Sys{ALT} лежит экспериментальный репозиторий \Sys{Sisyphus}, из которого формируются время от времени стабильные ветви (<<бранчи.>). В этих <<бранчах>> создаются коммерческие операционные системы. В декабре 2023 года стабильным бранчем являлся \Sys{p10} под названием <<Альт Платформа 10>>.

\Emph{Репозиторий программных пакетов} --- это замкнутая совокупность программных пакетов (исходных и 
собранных из них бинарных, плюс метаинформации о них) с поддерживаемой целостностью, то есть программы с 
формализованными инструкциями по установке и разрешёнными зависимостями.

Репозиторий пакетов и утилиты \Sys{APT} вместе автоматизируют процессы управления установкой, обновления и удаления
программного обеспечения; исключают риск случайного повреждения целостности операционной системы и прикладных 
программ.

Процесс взаимодействия пользователя с \Sys{APT}: Средствами APT по запросу пользователя загружаются метаданные
из репозитория, рассчитываются зависимости, \Sys{APT} получает от пользователя информацию о том,
какие именно пакеты обновить или установить. \Sys{APT} предлагает пути решения --- например, загрузку
новых пакетов из репозитория, установку дополнительных или обновление имеющихся пакетов.

\marginalia{ex_sign_col}{Для обновления практически всего программного обеспечения (за исключением ядра 
операционной системы) на локальном компьютере до новой версии необходимо выполнить команды:\\
	\Sys{\#apt-get update}\\
	\Sys{\#apt-get dist-upgrade}
}

При использовании \Sys{APT} и обновляемого стабильного репозитория операционная система может 
служить на компьютере годами, плавно обновляясь до новых версий.

\hypertarget{1.3}{\section{Сборка пакетов}}
\Emph{Сборка} --- формирование пакета на основе специальных сборочных(spec) инструкций.

 Упаковка программного обеспечения в пакеты \Sys{RPM}, а не обычный архив, имеет ряд
преимуществ\footnote{\href{https://rpm-packaging-guide-ru.github.io/\#Why-Package-Software-with-RPM}
{https://rpm-packaging-guide-ru.github.io/\#Why-Package-Software-with-RPM}} перед обычным архивированием:

\begin{itemize}
	\item Пользователи могут использовать средства управления пакетами (например, \Sys{Yum} или 
		\Sys{PackageKit}) для установки, переустановки, удаления, обновления и проверки пакетов \Sys{RPM}.
	\item Пакетный менеджер \Sys{RPM} предполагает наличие базы данных, которая с помощью специализированных 
		утилит позволяет получать информацию о пакетах в системе.
	\item Каждый пакет \Sys{RPM} содержит метаданные, описывающие компоненты пакета, версию, выпуск, 
		размер, URL проекта, установочные инструкции и~т.\,д.
	\item \Sys{RPM} позволяет брать оригинальные источники программного обеспечения и упаковывать их в 
		пакеты с исходным кодом(\Sys{.src.rpm}) и бинарные пакеты(\Sys{.rpm}). В пакетах с исходным кодом 
		хранятся оригинальные исходные данные вместе со всеми изменениями(\Sys{*.patch}), а так же сборочные 
		инструкции(\Sys{.spec}) и дополнительная информация. В бинарных пакетах вместо исходного кода 
		упакованы подготовленные файлы и скрипты установки, но нет сборочных инструкций. Ещё существуют 
		случаи распространения пакетов без исходного кода и бинарных данных, в таких пакетах присутствуют 
		скрипты для скачивания и модификации файлов, необходимых для работы приложения.
	\item Для обеспечения верификации подлинности \Sys{RPM}-пакетов используется механизм электронных цифровых 
		подписей \Sys{GPG}. Он позволяет подписать \Sys{RPM} пакет или обновить цифровую подпись: 
		\Sys{rpm -addsign package.rpm} и \Sys{rpm -resign package.rpm}.
	\item Вы можете добавить свой пакет в \Sys{RPM} репозиторий, что позволит клиентам легко находить и 
		устанавливать ваше программное обеспечение.
\end{itemize}

Задача сборки пакета начинается со сбора всех необходимых компонентов и завершается этапами сборки и тестирования.

Классическая сборка пакетов \Sys{rpm} состоит из следующих этапов:%\footnote{\href{https://alt-packaging-guide.github.io/}{https://alt-packaging-guide.github.io/}}:

\begin{itemize}
	\item поиск исходных данных;
	\item написание инструкций сборки;
	\item сборка пакета.
\end{itemize}

\section{Набор инструментов, необходимый для сборки}

Необходимые инструменты для сборки \Sys{rpm}-пакетов устанавливаются 
в системе через пакетный менеджер \Sys{apt} командой:\\
\Sys{\# apt-get install gcc rpm-build rpmlint make python gear hasher patch rpmdevtools}


В наборе параметров команды \Sys{install} перечислены имена пакетов, необходимых для сборочной 
инфраструктуры\footnote{\href{https://www.altlinux.org/\%D0\%A2\%D0\%B5\%D1\%85\%D0\%BD\%D0\%BE\%D0\%BB\%D0\%BE\%D0\%B3\%D0\%B8\%D1\%8F_\%D1\%81\%D0\%B1\%D0\%BE\%D1\%80\%D0\%BA\%D0\%B8_\%D0\%BF\%D0\%B0\%D0\%BA\%D0\%B5\%D1\%82\%D0\%BE\%D0\%B2_RPM}{https://www.altlinux.org/Технология\_сборки\_пакетов\_RPM}}:

\begin{itemize}
	\item \Sys{gcc} --- набор компиляторов для различных языков программирования, разработанный в рамках проекта GNU;
	\item \Sys{rpm-build} --- содержит сценарии и исполняемые программы, которые используются для сборки пакетов с помощью \Sys{RPM};
	\item \Sys{rpmlint} --- инструмент для проверки распространённых ошибок в пакетах \Sys{rpm}. Можно проверить бинарные и исходные пакеты;
	\item \Sys{make} --- инструмент GNU, упрощающий процесс сборки для пользователей;
	\item \Sys{python} --- интерпретируемый интерактивный объектно-ориентированный язык программирования;
	\item \Sys{gear} --- этот пакет содержит утилиты для сборки пакетов \Sys{RPM} из \Sys{GEAR}.репозитория и управления \Sys{GEAR}.репозиториями;
	\item \Sys{hasher} --- современная технология создания независимых от сборочной системы пакетов;
	\item \Sys{patch} --- программа исправлений применяет патчи к оригиналам;
	\item \Sys{rpmdevtools} --- пакет содержит скрипты и файлы поддерживающие \Sys{(X)Emacs}, помогающие в разработке пакетов \Sys{RPM}.
\end{itemize}

\section{Вопросы для самопроверки}

\begin{enumerate}
	\item Что такое программный пакет?
	\item Какие форматы пакетов вы знаете?
	\item Что такое репозиторий ПО?
	\item Какие низкоуровневые пакетные менеджеры вы знаете?
	\item Какой пакетный менеджер используется в Альт Платформа?
	\item Вы обнаружили в системе пакет \Sys{nagios-domain-discovery-0.1.1-alt1.noarch.rpm}, определите его имя, версию, релиз и архитектуру.
	\item Верно ли утверждение, что утилита \Sys{apt} при установке пакетв требует явного указания всех зависимых пакетов?
	\item Для чего нужна команда \Sys{apt-get update}?
	\item Выполнится ли успешно команда \verb!$ apt-get dist-upgrade!
	\item Какие инструменты (программы) нужны для сборки пакетов в <<Альт Платформа>>
\end{enumerate}
