\chapter{Пакетный менеджер}\label{package-manager}
Операционная система состоит из разнообразных компонентов: программ, библиотек, скриптов и приложений.
Число компонентов может достигать тысячи единиц, в каждой из которых могут быть включены десятки файлов.
Для удобства работы пользователя системные компоненты в \Sys{Linux} представлены в виде
пакетов\footnote{\href{https://docs.altlinux.org/books/altlibrary-linuxintro2.pdf}{Курячий Г., Маслинский К. (2010)}.
	Операционная система Linux. Курс лекций. ДМК Пресс.}. Пакет объединяет в общий архив сходные по назначению файлы: исполняемые программы, наборы библиотек, скрипты или конфигурационные файлы и данные.
Пользователь выбирает программы, ориентируясь на общеизвестное имя, устанавливает, обновляет, проверяет,
удаляет их, не вдаваясь в отдельные детали подбора всех необходимых файлов и компонентов.
Работа с пакетами позволяет сохранять целостность программы со всеми её компонентами.

\Emph{Пакет} --- это специально подготовленный архив, содержащий файлы данных, конфигурационные файлы,
управляющую информацию и метаданные. Метаданные пакета содержат полное имя, номер версии, принадлежность
архитектуре, цифровую подпись, описание пакета, информацию о лицензии и некоторую служебную информацию
о сборке. Управляющая информация пакета содержит сценарии установки и удаления пакета, зависимости
устанавливаемого пакета от других пакетов, краткое описание и прочую информацию, которую использует
менеджер пакетов. Пакеты принято хранить в специальном хранилище --- \Emph{репозитории пакетов}.

Для удобства работы команды разработчиков придумали собственные форматы архивов:

\begin{itemize}
	\item \Sys{RPM (.rpm)}. Разработан компанией \Sys{Red Hat}. Применяется в системе \Sys{<<Альт>>}, \Sys{Ред ОС}, \Sys{RHEL} и \Sys{CentOS}.
	\item \Sys{DEB (.deb)}. Формат пакетов дистрибутива \Sys{Debian}, а также \Sys{Ubuntu}.
	\item \Sys{TAR.XZ (.tar.xz)}. Применяется в дистрибутивах \Sys{ArchLinux} и \Sys{Manjaro}.
	\item \Sys{APK (.apk)}. Применяется в операционной системе \Sys{Android}.
\end{itemize}

Каждый пакет определяется именем, архитектурой системы, под которую он собран,
номером её версии и номером релиза этой программы в дистрибутиве. Если пакет не зависит
от архитектуры процессора, то в качестве архитектуры указывается <<noarch>>.

Например, \Sys{admc-0.15.0-alt1.x86\_64.rpm}:

\noindent
\hspace{0.2cm}
\begin{tabular}{ll}
	Имя: & \Sys{admc} \\
	Номер версии: & \Sys{0.15.0}\\
	Номер релиза: & \Sys{alt1}\\
	Архитектура: &  \Sys{x86\_64}\\
\end{tabular}

\hypertarget{require-def}{\Emph{Зависимость пакета}} --- потребность компонентов в составе пакета в ресурсах или компонентах прочих пакетов.
Может случиться, что для успешного запуска программы из одного пакета необходимы библиотеки или другие ресурсы,
которые находятся в другом пакете. В таком случае говорят о зависимости пакета от одного или нескольких пакетов.
Пакетный менеджер запретит установку пакета в систему без установки всех необходимых пакетов,
удовлетворяющих зависимости.

\Emph{Пакетный менеджер (система управления пакетами)} --- это система управления: установкой, удалением, настройкой
и обновлением пакетов. Пакетные менеджеры средствами входящих в их состав утилит упрощают для пользователя
процесс управления пакетами в операционной системе. Пакетный менеджер ведёт учёт пакетов, установленных в системе.
Существует менеджер зависимостей --- специальная программа, подбирающая пакеты, зависимые друг от друга, и
загружающая эти пакеты из
хранилища\footnote{\href{https://static-sl.insales.ru/files/1/3828/14544628/original/B-BHV-6630_part.pdf}
	{Кетов Д. (2021). Внутреннее устройство Linux. 2-е изд,. перераб. и доп. БХВ-Петербург.}}.
Менеджер зависимостей подбирает правильные версии пакетов и определяет порядок их установки.
При помощи менеджера зависимостей можно узнать с каким пакетом поставляется тот или иной файл.

Задачи пакетного менеджера:

\begin{itemize}
	\item \Emph{установка программ}. Позволяет устанавливать программы из центрального хранилища или из локальных источников;
	\item \Emph{обновление программ}. Позволяет обновлять установленные программы до последних версий, представленных в хранилище;
	\item \Emph{удаление программ}. Позволяет безопасно удалять программы и все связанные с ними файлы;
	\item \Emph{управление зависимостями}. Автоматически устанавливает и управляет зависимостями программ;
	\item \Emph{проверка целостности пакетов}. Предотвращает конфликты при установке новых программ, обеспечивая целостность системы.
\end{itemize}

Утилиты пакетного менеджера позволяют:

\begin{itemize}
	\item узнать информацию о пакете;
	\item определить пакет, которому принадлежит установленная программа;
	\item определить список компонентов, установленных из указанного пакета.
\end{itemize}

Среди утилит пакетного менеджера можно выделить две категории --- низкоуровневые и высокоуровневые.

\begin{itemize}
	\item \Emph{Низкоуровневые утилиты пакетного менеджера}. Используются для установки
	локальных пакетов, загруженных вручную пользователем или высокоуровневым пакетным менеджером.
	\item \Emph{Высокоуровневые утилиты}. Применяются для поиска и скачивания пакетов из репозиториев.
	В процессе работы могут задействовать низкоуровневые менеджеры для установки загруженных программ.
\end{itemize}

В операционной системе \Sys{<<Альт>>} используется формат пакетов \Sys{.rpm}.
Пакеты \Sys{rpm} хранятся в удалённом хранилище.
Для работы с такими пакетами применяется низкоуровневый пакетный менеджер \Sys{RPM}
и консольныe утилиты \Sys{APT} (Advanced Packaging Tool)%
\footnote{\href{https://wiki.altlinux.ru/QuickStart/PkgManagment\#\%D0\%9E\%D1\%81\%D0\%BD\%D0\%BE\%D0\%B2\%D0\%BD\%D1\%8B\%D0\%B5_\%D0\%B8\%D0\%BD\%D1\%81\%D1\%82\%D1\%80\%D1\%83\%D0\%BC\%D0\%B5\%D0\%BD\%D1\%82\%D1\%8B_\%D0\%B4\%D0\%BB\%D1\%8F_\%D1\%83\%D0\%BF\%D1\%80\%D0\%B0\%D0\%B2\%D0\%BB\%D0\%B5\%D0\%BD\%D0\%B8\%D1\%8F_\%D0\%BF\%D0\%B0\%D0\%BA\%D0\%B5\%D1\%82\%D0\%B0\%D0\%BC\%D0\%B8}{https://wiki.altlinux.ru/QuickStart/PkgManagment}}.

\begin{itemize}
	\item \Emph{RPM} используется для просмотра, сборки, установки, инспекции,
		проверки, обновления и удаления отдельных программных пакетов. Каждый такой пакет состоит
		из набора файлов и информации о пакете, включающей название, версию, описание пакета и~т.\,д.
	\item \Emph{APT} умеет автоматически
		разрешать зависимости при установке, обеспечивает установку из нескольких источников и целый
		ряд других уникальных возможностей, включая получение последней версии списка пакетов из
		репозитория и обновление системы.
\end{itemize}

\section{RPM: основной пакетный менеджер в <<Альт Платформа>>}
В дистрибутивах \Sys{<<Альт>>} применяется пакетный менеджер \Sys{RPM}. \Sys{RPM Package Manager} ---
это семейство пакетных менеджеров, применяемых в различных дистрибутивах \Sys{GNU/Linux}.
Практически каждый крупный проект, использующий \Sys{RPM}, имеет свою версию пакетного менеджера,
отличающуюся от остальных.

Различия между представителями семейства \Sys{RPM} выражаются в:

\begin{itemize}
	\item наборе макросов, используемых в \Sys{.spec-файлах};
	\item различии сборки \Sys{rpm}-пакетов <<по умолчанию>> --- при отсутствии каких-либо
	указаний в \Sys{.spec}-файлах, формате строк зависимостей;
	\item отличиях в семантике операций (например, в операциях сравнения версий пакетов);
	\item отличиях в формате файлов.
\end{itemize}

Обратим внимание на то, что в операционных системах ALT ведется самостоятельная
разработка формата \Sys{.rpm} и пакетного менеджера \Sys{APT}. Набор утилит \Sys{APT} в ALT отличается
от аналогичной по названию программы в Debian, также как и \Sys{RPM} отличается от
аналогичного пакетного менеджера в RedHat.

\section{APT: инструменты управления пакетами}
\Sys{APT} --- часть системы управления пакетами в дистибутивах <<Альт>>. \Sys{Advanced Packaging Tool}
(усовершенствованный инструмент работы с пакетами) это набор утилит, позволяющий управлять пакетами.
\Sys{APT}  поддерживает загрузку пакетов из хранилища (репозитория).

\Emph{Хранилище(репозиторий)} ---  в общем виде хранилище данных.

В операционной системе \Sys{<<Альт>>} пакетный менеджер работает с репозиторием \Sys{rpm}-пакетов.

\Emph{Репозиторий пакетов} --- это замкнутая совокупность компонентов системы с
поддерживаемой целостностью и метаинформацией о них, то есть структурированные
компоненты с формализованными инструкциями по установке и разрешенными зависимостями.

Хранилище состоит из двух частей --- индексы (списки пакетов со служебной информацией) и
хранилище (структурированные файлы пакетов).
\Sys{APT} в зависимости от настроек может использовать удалённый репозиторий
с помощью сетевого протокола (например, \Sys{ftp}) или локальный репозиторий (например,
на оптическом диске).
Список источников пакетов хранится в файле
\Sys{/etc/apt/sources.list} и в каталоге \Sys{/etc/apt/sources.list.d/}. В системе \Sys{<<Альт>>}
применяется графическая оболочка для \Sys{APT} --- программа \Sys{Synaptic}\footnote{APT и Synaptic
	развиваются ALT Linux Team, не нужно сравнивать реализации с аналогичными утилитами в \Sys{Debian}}.
Утилита \Sys{apt-get} значительно упрощает процесс установки программ в командном режиме.

\marginalia{ex_sign_col}{Для сокращения команд, встречающихся в тексте,  используется нотация:
	\begin{itemize}
		\item[-] команды \textbf{без административных привилегий} начинаются с
		символа <<\$>>;
		\item[-] команды \textbf{с административными привилегиями} начинаются с символа <<\#>>.
\end{itemize}}

Команда \Sys{\$ apt-get} выведет описание и возможности утилиты \Sys{apt-get}:
\begin{verbatim}
    $ apt-get
   apt 0.5.15lorg2 для linux x86_64 собран Jul 26 2023 18:10:41
   Использование: apt-get [параметры] команда
      apt-get [параметры] install|remove пакет1 [пакет2 ...]
      apt-get [параметры] source пакет1 [пакет2 ...]
\end{verbatim}

apt-get предоставляет простой командный интерфейс для получения и
установки пакетов. Чаще других используются команды update (обновить)
и install (установить).
	
Команды:
\begin{itemize}
	\item \Sys{update} --- получить обновлённые списки пакетов;
	\item \Sys{upgrade} --- произвести обновление;
	\item \Sys{install} --- установить новые пакеты;
	\item \Sys{remove} --- удалить пакеты;
	\item \Sys{source} --- скачать архивы исходников;
	\item \Sys{build-dep} --- установить всё необходимое для сборки исходных пакетов;
	\item \Sys{dist-upgrade} --- обновление системы в целом;
	\item \Sys{clean} --- удалить скачанные ранее архивные файлы;
	\item \Sys{autoclean} --- удалить давно скачанные архивные файлы;
	\item \Sys{check} --- удостовериться в отсутствии неудовлетворённых зависимостей;
	\item \Sys{dedup} --- удаление неразрешенных дупликатов пакетов.
\end{itemize}
	
Параметры:
\begin{itemize}
	\item \Sys{-h} --- краткая справка;
	\item \Sys{-q} --- скрыть индикатор процесса;
	\item \Sys{-qq}--- не показывать ничего кроме сообщений об ошибках;
	\item \Sys{-d} --- получить пакеты и выйти БЕЗ их установки или распаковки;
	\item \Sys{-s} --- симулировать упорядочение вместо реального исполнения;
	\item \Sys{-y} --- автоматически отвечать <<ДА>> на все вопросы;
	\item \Sys{-f} --- пытаться исправить положение, если найдены неудовлетворённые зависимости;
	\item \Sys{-m} --- пытаться продолжить, если часть архивов недоступна;
	\item \Sys{-u} --- показать список обновляемых пакетов;
	\item \Sys{-b} --- собрать пакет после получения его исходника;
	\item \Sys{-D} --- при удалении пакета стремиться удалить компоненты, от которых он зависит;
	\item \Sys{-V} --- подробно показывать номера версий;
	\item \Sys{-c=?} --- использовать указанный файл конфигурации;
	\item \Sys{-o=?} --- изменить любой из параметров настройки (например: \Sys{-o dir::cache=/tmp}).
\end{itemize}

Более полное описание доступно на страницах руководства man:
\Sys{apt-get, sources.list} и \Sys{apt.conf}:
\begin{itemize}
	\item\begin{verbatim}$ man apt-get\end{verbatim}
	\item\begin{verbatim}$ man sources.list\end{verbatim}
	\item\begin{verbatim}$ man apt.conf\end{verbatim}
\end{itemize}

В ОС \Sys{<<Альт>>} утилита \Sys{apt-get} использует основной пакетный менеджер \Sys{RPM Package Manager} для установки, обновления, удаления пакетов, управления зависимостями. Обе
утилиты \Sys{rpm} и \Sys{apt-get} позволяют установить, обновить или удалить пакет.

Отличия \Sys{rpm} и \Sys{apt-get}:
\begin{itemize}
	\item \Sys{apt-get} учитывает зависимости устанавливаемого пакета;
	\item \Sys{apt-get} умеет работать с репозиторием в целом:
	\begin{itemize}
		\item искать пакеты;
		\item вычислять список обновлений --- находить разницу версий пакетов,
		установленных локально и хранящихся в репозитории;
	\end{itemize}
	\item \Sys{apt-get} получает информацию из пакетов, используя \Sys{rpm}.
\end{itemize}

Утилита \Sys{rpm} подразумевает работу с конкретными пакетами. Пользователь самостоятельно
принимает решения, связанные с зависимостями пакетов  при работе с \Sys{RPM}. Утилита \Sys{apt-get}
вычисляет и устанавливает необходимые пакеты из репозитория, чтобы удовлетворить зависимости для
каждого \Sys{rpm}-пакета. Утилита \Sys{apt-get} самостоятельно не устанавливает пакеты, а использует для этого \Sys{RPM}.

\marginalia{ex_sign_col}{Установка пакетов в <<Альт Платформа>> осуществляется с помощью утилиты \Sys{apt}}

Целостность компонентов репозитория пакетов обеспечивает инфраструктура разработки операционной системы <<Альт>>.
Результат работы инфраструктуры это репозиторий пакетов. Каждый пакет репозитория формируется на
основе исходных данных пакета. Множество таких исходных данных для каждого пакета составляют git-репозиторий.

\Emph{Git-репозиторий} --- хранилище исходных данных с сохранением истории изменений каждого файла
хранилища. В данном контексте мы подразумеваем множество репозиториев исходных данных компонентов
системы (будь то ядро операционной системы, служебная библиотека, текстовый редактор, сервер для обслуживания
электронных сообщений или набор изображения для оформления графической среды), входящих в операционную
систему \Sys{ALT}.

Инфраструктура разработки \Sys{ALT} на основе подготовленных для сборки в пакеты исходных данных компонентов
системы выполняет типовые операции:
\begin{itemize}
	\item собирает компонент в соответствии с подготовленными инструкциями;
	\item проверяет целостность каждого компонента;
	\item проверяет зависимости и целостность связанных компонентов;
	\item добавляет пакет в репозиторий пакетов, если все условия выполнены.
\end{itemize}

Поддерживаемые в \Sys{ALT} репозитории пакеты называются <<Альт Платформа>> и обладают уникальным идентификатором
репозитория. В декабре 2023 года сформирован и поддерживается репозиторий \Sys{p10} под названием <<Альт~Платформа~10>>.

Репозиторий пакетов и утилиты \Sys{APT} вместе автоматизируют процессы управления установкой, обновления и удаления
программного обеспечения, исключают риск случайного повреждения целостности операционной системы и прикладных
программ.

Процесс взаимодействия пользователя с \Sys{APT}:
\begin{itemize}
	\item средствами \Sys{APT} по запросу пользователя загружаются метаданные из репозитория;
	\item \Sys{APT} получает от пользователя информацию о том, какие именно пакеты обновить или установить;
	\item \Sys{APT} проверяет зависимости и возможные конфликты компонентов;
	\item \Sys{APT} предлагает пути решения, например, загрузку новых пакетов из репозитория, установку дополнительных или обновление имеющихся пакетов.
\end{itemize}

\marginalia{ex_sign_col}{Для обновления практически всего программного обеспечения (за исключением ядра
	операционной системы) на локальном компьютере до новой версии необходимо выполнить команды:\\
	\Sys{\#apt-get update}\\
	\Sys{\#apt-get dist-upgrade}
}

При использовании \Sys{APT} и обновляемого стабильного репозитория операционная система может
служить на компьютере годами, гарантировано обновляясь до новых версий.

\section{Вопросы для самопроверки}

\begin{enumerate}
	\item Что такое пакет?
	\item Какие форматы пакетов вы знаете?
	\item Что такое зависимость пакета?
	\item Что такое репозиторий пакетов?
	\item Какие низкоуровневые пакетные менеджеры вы знаете?
	\item Какой пакетный менеджер используется в <<Альт Платформа>>?
	\item Вы обнаружили в системе пакет \Sys{nagios-domain-discovery-0.1.1-alt1.noarch.rpm}, определите его имя, версию, релиз и архитектуру.
	\item Верно ли утверждение, что утилита \Sys{apt-get} при установке пакетов требует явного указания всех зависимых пакетов?
	\item Для чего используется команда \Sys{apt-get update}?
	\item Выполнится ли успешно команда \verb!$ apt-get dist-upgrade!?
\end{enumerate}
